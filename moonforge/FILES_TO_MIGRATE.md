# Files That Need Migration to New Drift Database

Progress: 20/45 complete (44%) — Core + Campaign + Chapter done; continuing with Adventure, Scene, Encounters, Entities, Session, Home.

This document lists all files that currently import from the old `data/firebase/models/` and need to be updated to use the new Drift database models from `data/db/app_db.dart`.

## Migration Strategy

For each file below:
1. Remove imports from `package:moonforge/data/firebase/models/*`
2. Add import: `import 'package:moonforge/data/db/app_db.dart';`
3. Remove any `firestore_odm` package imports
4. Remove any `Odm.instance` references
5. Update model usage to use Drift-generated classes (Campaign, Chapter, Adventure, etc.)
6. Update repository access to use new repositories from `data/repo/`

## Core Providers (2 files)

- [x] `lib/core/providers/app_settings_provider.dart`
- [x] `lib/core/providers/auth_providers.dart`

## Core Services (2 files)

- [x] `lib/core/services/breadcrumb_service.dart`
- [x] `lib/core/services/entity_gatherer.dart`

## Core Utils (1 file)

- [x] `lib/core/utils/permissions_utils.dart`

## Core Widgets (6 files)

- [x] `lib/core/widgets/app_state_initializer.dart`
- [x] `lib/core/widgets/entities_widget.dart`
- [x] `lib/core/widgets/entity_widgets_wrappers.dart`
- [x] `lib/core/widgets/quill_mention/custom_quill_editor.dart`
- [x] `lib/core/widgets/quill_mention/entity_mention_service.dart`
- [x] `lib/core/widgets/share_settings_dialog.dart`

## Campaign Feature (4 files)

- [x] `lib/features/campaign/controllers/campaign_provider.dart`
- [x] `lib/features/campaign/utils/create_campaign.dart`
- [x] `lib/features/campaign/views/campaign_edit_screen.dart`
- [x] `lib/features/campaign/views/campaign_screen.dart`

## Chapter Feature (5 files)

- [x] `lib/features/chapter/utils/create_adventure_in_chapter.dart`
- [x] `lib/features/chapter/utils/create_chapter.dart`
- [x] `lib/features/chapter/utils/create_scene_in_chapter.dart`
- [x] `lib/features/chapter/views/chapter_edit_screen.dart`
- [x] `lib/features/chapter/views/chapter_screen.dart`

## Adventure Feature (3 files)

- [ ] `lib/features/adventure/utils/create_adventure.dart`
- [ ] `lib/features/adventure/views/adventure_edit_screen.dart`
- [ ] `lib/features/adventure/views/adventure_screen.dart`

## Scene Feature (3 files)

- [ ] `lib/features/scene/utils/create_scene.dart`
- [ ] `lib/features/scene/views/scene_edit_screen.dart`
- [ ] `lib/features/scene/views/scene_screen.dart`

## Encounters Feature (9 files)

- [ ] `lib/features/encounters/services/encounter_difficulty_service.dart`
- [ ] `lib/features/encounters/services/initiative_tracker_service.dart`
- [ ] `lib/features/encounters/utils/create_encounter.dart`
- [ ] `lib/features/encounters/utils/create_encounter_in_adventure.dart`
- [ ] `lib/features/encounters/utils/create_encounter_in_chapter.dart`
- [ ] `lib/features/encounters/utils/create_encounter_in_scene.dart`
- [ ] `lib/features/encounters/views/encounter_edit_screen.dart`
- [ ] `lib/features/encounters/views/encounter_screen.dart`
- [ ] `lib/features/encounters/views/initiative_tracker_screen.dart`

## Entities Feature (6 files)

- [ ] `lib/features/entities/utils/create_entity.dart`
- [ ] `lib/features/entities/utils/create_entity_in_adventure.dart`
- [ ] `lib/features/entities/utils/create_entity_in_chapter.dart`
- [ ] `lib/features/entities/utils/create_entity_in_scene.dart`
- [ ] `lib/features/entities/views/entity_edit_screen.dart`
- [ ] `lib/features/entities/views/entity_screen.dart`

## Session Feature (3 files)

- [ ] `lib/features/session/views/session_edit_screen.dart`
- [ ] `lib/features/session/views/session_public_share_screen.dart`
- [ ] `lib/features/session/views/session_screen.dart`

## Home Feature (1 file)

- [ ] `lib/features/home/views/home_screen.dart`

---

## Total: 45 files — 20 complete, 25 remaining

## Common Patterns to Replace

### Old Import Pattern
```dart
import 'package:moonforge/data/firebase/models/campaign.dart';
import 'package:moonforge/data/firebase/models/chapter.dart';
// etc.
```

### New Import Pattern
```dart
import 'package:moonforge/data/db/app_db.dart';
```

### Repository Access

**Old (firestore_odm):**
```dart
final campaignsRef = Odm.instance.campaigns;
final doc = await campaignsRef.doc(id).get();
```

**New (Drift repositories):**
```dart
final repo = context.read<CampaignRepository>();
final campaign = await repo.getById(id);
```

### Model Usage

Models are now generated by Drift and accessed from `app_db.dart`:
- `Campaign` (from Drift, not firestore_odm)
- `Chapter` (from Drift)
- `Adventure` (from Drift)
- `Scene` (from Drift)
- `Entity` (from Drift)
- `Encounter` (from Drift)
- `Party` (from Drift)
- `Session` (from Drift)
- etc.

## Important Notes

1. **Companion Classes**: For inserts/updates, use Drift's Companion classes:
   - `CampaignsCompanion`, `ChaptersCompanion`, etc.
   - These use `Value<T>` wrappers for nullable fields

2. **Streams**: Repositories provide `watch*()` methods that return `Stream<T>`:
   ```dart
   Stream<List<Campaign>> campaigns = repo.watchAll();
   ```

3. **Transactions**: All writes go through repositories which handle:
   - Local Drift transaction
   - Outbox queueing for sync
   - Automatic conflict resolution

4. **No Direct Firestore Access**: UI should NEVER read from Firestore directly
   - All reads from Drift (local DB)
   - All writes via repositories (local + queued sync)

## Next Steps

1. Migrate files incrementally by feature or layer
2. Test each file after migration
3. Run `flutter analyze` to catch type errors
4. Run `flutter test` to ensure tests pass
5. Check mark each file in this list as it's completed
