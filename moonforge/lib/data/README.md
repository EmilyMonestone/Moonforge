# Drift Offline-First Data Layer

This directory contains the local-first data infrastructure using Drift (SQLite) as the source of truth, with bidirectional sync to Firestore.

## Structure

```
lib/data/
├── drift/              # Drift database infrastructure
│   ├── connect/        # Platform-specific connections (web WASM / native)
│   ├── converters/     # Type converters for Drift columns
│   ├── dao/            # Data Access Objects
│   ├── tables/         # Table definitions
│   └── app_database.dart  # Main database class
├── repo/               # Repository pattern (business logic)
├── sync/               # Sync engine (Drift ↔ Firestore)
├── examples/           # Example widgets
└── drift_providers.dart  # Provider wiring
```

## Quick Start

1. **Generate code**:
   ```bash
   cd moonforge
   flutter pub get
   flutter pub run build_runner build --delete-conflicting-outputs
   ```

2. **Set up web assets** (for web platform):
   - Copy `sqlite3.wasm` and `drift_worker.dart.js` to `/web` directory
   - See `../../../docs/drift_web_setup.md` for details

3. **Use in your app**:
   ```dart
   import 'package:moonforge/data/drift_providers.dart';
   
   MultiProvider(
     providers: [
       ...driftProviders(),
       // ... other providers
     ],
     child: MyApp(),
   )
   ```

## Key Features

- **Local-First**: Instant reads/writes from SQLite
- **Offline Support**: Full functionality without network
- **Automatic Sync**: Background sync with Firestore
- **Conflict Resolution**: CAS (Compare-And-Set) on revision field
- **Cross-Platform**: Mobile, desktop, and web (WASM)
- **Type-Safe**: Uses existing Freezed models via `@UseRowClass`

## Architecture

```
UI Widget
    ↓ context.watch<List<Campaign>>()
Repository
    ↓ upsertLocal() / patchLocal()
Drift SQLite (source of truth)
    ↓ transaction + enqueue
Outbox Queue
    ↓ background processing
Sync Engine (CAS conflict resolution)
    ↓ Firestore transaction
Firestore (remote sync)
```

## Documentation

- **Full Usage Guide**: `../../../DRIFT_USAGE.md`
- **Architecture & Design**: `../../../DRIFT_CHANGELOG.md`
- **Web Setup**: `../../../docs/drift_web_setup.md`

## Testing

```bash
flutter test test/data/drift/    # DAO and migration tests
flutter test test/data/repo/     # Repository tests
```

## Adding New Models

To add offline-first support for a new model (e.g., `Chapter`):

1. Create table in `drift/tables/chapter.dart`:
   ```dart
   @UseRowClass(Chapter)
   class Chapters extends Table { ... }
   ```

2. Create DAO in `drift/dao/chapters_dao.dart`

3. Register in `app_database.dart`:
   ```dart
   @DriftDatabase(
     tables: [Campaigns, Chapters, ...],
     daos: [CampaignsDao, ChaptersDao, ...],
   )
   ```

4. Create repository in `repo/chapter_repository.dart`

5. Wire up providers in `drift_providers.dart`

6. Bump `schemaVersion` and add migration if needed

## Generated Files

These files are generated by `build_runner` and should **not** be edited manually:

- `drift/app_database.g.dart`
- `drift/dao/campaigns_dao.g.dart`
- `drift/dao/outbox_dao.g.dart`

## Helper Script

Run `../../../scripts/drift_setup.sh` to automate code generation and web asset setup.
