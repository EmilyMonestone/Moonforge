rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Only authenticated users can access data.
    function isSignedIn() {
      return request.auth != null;
    }

    // A user is a campaign member if they are the owner or included in memberUids.
    function isCampaignMember(cid) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/campaigns/$(cid)) &&
        (
          get(/databases/$(database)/documents/campaigns/$(cid)).data.ownerUid == request.auth.uid ||
          (request.auth.uid in get(/databases/$(database)/documents/campaigns/$(cid)).data.memberUids)
        );
    }

    // Resolve a campaignId from an adventure id safely (no 'let' usage)
    function campaignIdForAdventure(advId) {
      return (
        exists(/databases/$(database)/documents/adventures/$(advId)) &&
        get(/databases/$(database)/documents/adventures/$(advId)).data.chapterId != null &&
        exists(/databases/$(database)/documents/chapters/$(get(/databases/$(database)/documents/adventures/$(advId)).data.chapterId))
      )
      ? get(/databases/$(database)/documents/chapters/$(get(/databases/$(database)/documents/adventures/$(advId)).data.chapterId)).data.campaignId
      : null;
    }

    // Resolve a campaignId from a scene id
    function campaignIdForScene(sceneId) {
      return exists(/databases/$(database)/documents/scenes/$(sceneId))
        ? campaignIdForAdventure(get(/databases/$(database)/documents/scenes/$(sceneId)).data.adventureId)
        : null;
    }

    // Resolve a campaignId from an originId which may be a campaign, chapter, adventure or scene
    function campaignIdFromOrigin(originId) {
      return exists(/databases/$(database)/documents/campaigns/$(originId)) ? originId
        : (exists(/databases/$(database)/documents/chapters/$(originId))
            ? get(/databases/$(database)/documents/chapters/$(originId)).data.campaignId
            : (exists(/databases/$(database)/documents/adventures/$(originId))
                ? campaignIdForAdventure(originId)
                : (exists(/databases/$(database)/documents/scenes/$(originId))
                    ? campaignIdForScene(originId)
                    : null)));
    }

    // Allow each authenticated user to read/write their own user document
    match /users/{uid} {
      allow read, write: if isSignedIn() && request.auth.uid == uid;
    }

    // Top-level campaigns collection
    match /campaigns/{cid} {
      // Creating a campaign: must be signed in and set themselves as owner.
      // Also require memberUids to include the owner to ensure consistent membership state.
      allow create: if isSignedIn() &&
        request.resource.data.ownerUid == request.auth.uid &&
        request.resource.data.memberUids != null &&
        (request.auth.uid in request.resource.data.memberUids);

      // Allow reads if the requester is the owner or a member â€” use resource.data so queries work
      allow read: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid ||
        (request.auth.uid in resource.data.memberUids)
      );

      // Updates and deletes require membership and must not change ownership
      allow update, delete: if isCampaignMember(cid) &&
        request.resource.data.ownerUid == resource.data.ownerUid;

      // All subcollections under a campaign inherit membership checks.
      match /{document=**} {
        allow read, write: if isCampaignMember(cid);
      }
    }

    // Flat collections with campaign membership

    // Chapters (FK: campaignId)
    match /chapters/{id} {
      allow read: if isSignedIn() && isCampaignMember(resource.data.campaignId);
      allow create: if isSignedIn() && isCampaignMember(request.resource.data.campaignId);
      allow update, delete: if isSignedIn() && isCampaignMember(resource.data.campaignId) &&
        request.resource.data.campaignId == resource.data.campaignId;
    }

    // Adventures (FK: chapterId -> campaignId)
    match /adventures/{id} {
      function _campaignId() {
        return exists(/databases/$(database)/documents/chapters/$(resource.data.chapterId))
          ? get(/databases/$(database)/documents/chapters/$(resource.data.chapterId)).data.campaignId
          : null;
      }
      function _newCampaignId() {
        return exists(/databases/$(database)/documents/chapters/$(request.resource.data.chapterId))
          ? get(/databases/$(database)/documents/chapters/$(request.resource.data.chapterId)).data.campaignId
          : null;
      }
      allow read: if isSignedIn() && isCampaignMember(_campaignId());
      allow create: if isSignedIn() && isCampaignMember(_newCampaignId());
      allow update, delete: if isSignedIn() && isCampaignMember(_campaignId()) &&
        _campaignId() == _newCampaignId();
    }

    // Scenes (FK: adventureId -> chapterId -> campaignId)
    match /scenes/{id} {
      function _campaignId() { return campaignIdForScene(id); }
      function _newCampaignId() { return campaignIdForAdventure(request.resource.data.adventureId); }
      allow read: if isSignedIn() && isCampaignMember(_campaignId());
      allow create: if isSignedIn() && isCampaignMember(_newCampaignId());
      allow update, delete: if isSignedIn() && isCampaignMember(_campaignId()) && _campaignId() == _newCampaignId();
    }

    // Entities (FK-like: originId -> campaign/chapter/adventure/scene)
    match /entities/{eid} {
      function _campaignId() { return campaignIdFromOrigin(resource.data.originId); }
      function _newCampaignId() { return campaignIdFromOrigin(request.resource.data.originId); }
      allow read: if isSignedIn() && isCampaignMember(_campaignId());
      allow create: if isSignedIn() && isCampaignMember(_newCampaignId());
      allow update, delete: if isSignedIn() && isCampaignMember(_campaignId()) && _campaignId() == _newCampaignId();
    }

    // Encounters (FK-like: originId -> campaign/chapter/adventure/scene)
    match /encounters/{encId} {
      function _campaignId() { return campaignIdFromOrigin(resource.data.originId); }
      function _newCampaignId() { return campaignIdFromOrigin(request.resource.data.originId); }
      allow read: if isSignedIn() && isCampaignMember(_campaignId());
      allow create: if isSignedIn() && isCampaignMember(_newCampaignId());
      allow update, delete: if isSignedIn() && isCampaignMember(_campaignId()) && _campaignId() == _newCampaignId();
    }

    // Parties (FK: campaignId) - prefer players but legacy entity membership allowed
    match /parties/{pid} {
      allow read: if isSignedIn() && isCampaignMember(resource.data.campaignId);
      allow create: if isSignedIn() && isCampaignMember(request.resource.data.campaignId);
      allow update, delete: if isSignedIn() && isCampaignMember(resource.data.campaignId) &&
        request.resource.data.campaignId == resource.data.campaignId;
    }

    // Players (FK: campaignId) - writable by DM (campaign member) or owning player
    match /players/{playerId} {
      allow read: if isSignedIn() && isCampaignMember(resource.data.campaignId);
      allow create: if isSignedIn() && isCampaignMember(request.resource.data.campaignId);
      allow update: if isSignedIn() && (
        isCampaignMember(resource.data.campaignId) ||
        (resource.data.playerUid != null && resource.data.playerUid == request.auth.uid &&
         request.resource.data.playerUid == request.auth.uid)
      ) && request.resource.data.campaignId == resource.data.campaignId;
      allow delete: if isSignedIn() && isCampaignMember(resource.data.campaignId);
    }

    // Media assets: currently allow any signed-in user (refine with campaign scoping later if needed)
    match /mediaAssets/{assetId} {
      allow read, create, update, delete: if isSignedIn();
    }

    // Sessions: currently not scoped to campaign; restrict to signed-in users
    match /sessions/{sid} {
      allow read, create, update, delete: if isSignedIn();
    }

    // Joins collection: invite/join codes for campaigns
    match /joins/{code} {
      // Allow reading valid (non-expired) codes to any signed-in user
      allow read: if isSignedIn() &&
        (resource.data.ttl == null || request.time < resource.data.ttl);

      // Create/update/delete only by campaign members of the referenced campaign
      // For create/update, use request.resource; for delete, fall back to stored resource
      allow create: if isSignedIn() &&
        (request.resource.data.ttl == null || request.time < request.resource.data.ttl) &&
        isCampaignMember(request.resource.data.cid);

      allow update: if isSignedIn() &&
        (request.resource.data.ttl == null || request.time < request.resource.data.ttl) &&
        isCampaignMember(request.resource.data.cid);

      allow delete: if isSignedIn() && isCampaignMember(resource.data.cid);
    }

    // Deny everything else by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}