rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Only authenticated users can access data.
    function isSignedIn() {
      return request.auth != null;
    }

    // A user is a campaign member if they are the owner or included in memberUids.
    function isCampaignMember(cid) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/campaigns/$(cid)) &&
        (
          get(/databases/$(database)/documents/campaigns/$(cid)).data.ownerUid == request.auth.uid ||
          (request.auth.uid in get(/databases/$(database)/documents/campaigns/$(cid)).data.memberUids)
        );
    }

    // Top-level campaigns collection
    match /campaigns/{cid} {
      // Creating a campaign: must be signed in and set themselves as owner.
      allow create: if isSignedIn() &&
        request.resource.data.ownerUid == request.auth.uid;

      // Read/update/delete if member (owner or in memberUids)
      allow read, update, delete: if isCampaignMember(cid);

      // All subcollections under a campaign inherit membership checks.
      match /{document=**} {
        allow read, write: if isCampaignMember(cid);
      }
    }

    // Deny everything else by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}